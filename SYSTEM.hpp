#pragma once
#include "DA_GUI.h"
#include "DA_RANSAC.hpp"
#include "DA_SLAM.hpp"
#include "logger.hpp"
#include <iostream>

/*
Starts and initializes everything

*/
namespace DA {
	class SYSTEM {
	public:
		SYSTEM() : running(true) {}

		void commandEvaluation() {
			std::cout << "Enter commands to controll the robot.\nType 'help' for a list of commands" << std::endl;

			this->command_th = std::thread();
		}

		void setupGUI() {
			processLogger.start("logs\\process.log");
			commandLogger.start("logs\\command.log");

			this->timer = new Timer();

			gui.addPointType("laserreadingType", 1.f, 0u, 0u, 0u, 255u, true);
			gui.addPointType("landmarkType", 4.f, "Red", true);
			gui.addTriangle(5.f, 0.f, { 0.f,0.f }, "Red", true);
			gui.addLineType("landmarkLineType", "White", "Black", true);
			gui.addTextType("headingType", "Roboto-Medium.ttf", { 20.f, 20.f }, 16u, "Black", false);
			gui.addTextType("informationType", "Roboto-Medium.ttf", { 20.f, 100.f }, 12u, "Black", false);
			gui.addTextType("informationValues", "Roboto-Medium.ttf", { 200.f, 100.f }, 12u, "Black", false);

			gui.addText("Omnidirektionale Transporteinheit", "headingType");
			gui.addText("elapsed time [s]:", "informationType");
			gui.addText("\nlandmark count:", "informationType");
			gui.addText("\ncomputing time [s]:", "informationType");
			gui.addText("\nring radius [mm]:", "informationType");
			gui.addText("\npoint quantity:", "informationType");
			gui.addText("\nerror count:", "informationType");
			gui.addText("\nzoom devisor:", "informationType");

			for (unsigned int i = 0u; i < 5u; i++) gui.addRing(ringRadius * i, 1.f, { 0.f,0.f }, 200u, 200u, 200u, 255u, true);

			gui.addRectangle(280u, this->gui.windowSize.y - 20.f, 0.f, { 10.f,10.f }, 200u, 200u, 200u, 200u, false);

			gui.openWindow("VERONIX", this->windowSize);

			processLogger.writeLine("system setup finished");
		}

		void startTesting() {
			this->testMode = true;
			std::vector<DA::Point> testPoints = { {623.118347, -880.888428},{598.583557, -865.102173},{575.005554, -849.732056},{552.916504, -835.635925},{532.269409, -822.854370},{512.482788, -810.581543},{493.009338, -797.988586},{474.887054, -786.793030},{457.050720, -775.309387},{440.003876, -764.408691},{423.723358, -754.111084},{407.704529, -743.559692},{392.894745, -734.522095},{378.316956, -725.258728},{363.974182, -715.773560},{350.758301, -707.862000},{337.745972, -699.754700},{325.366028, -692.359680},{312.759644, -683.875305},{301.178406, -677.032166},{289.773132, -670.023560},{278.546265, -662.852173},{267.877808, -656.446838},{257.372253, -649.892700},{247.391052, -644.125549},{237.557358, -638.222107},{227.872940, -632.185059},{218.339478, -626.016663},{209.278778, -620.666870},{200.042572, -614.246704},{191.078903, -609.762146},{182.415131, -604.057678},{174.170471, -599.200012},{166.046616, -594.236938},{158.045013, -589.170410},{150.416519, -584.970825},{142.892319, -580.677002},{135.244431, -575.317261},{129.039581, -575.715881},{118.448112, -555.512451},{113.863281, -562.593201},{107.067139, -558.835938},{99.825455, -552.046997},{93.578636, -550.097290},{87.066856, -546.102905},{80.647957, -542.033142},{74.460953, -538.879883},{68.221077, -534.665222},{62.193859, -531.372681},{56.135723, -527.018799},{50.270981, -523.592224},{44.483845, -520.101135},{38.774651, -516.546753},{33.209301, -513.928162},{27.647770, -510.251495},{22.210751, -507.514221},{16.799471, -503.719940},{11.493281, -500.868164},{6.248088, -497.960785},{1.064589, -494.998840},{-4.056650, -491.983276},{-9.115194, -488.915039},{-14.110388, -485.795105},{-19.041706, -482.624512},{-23.957647, -480.402985},{-28.829588, -478.131622},{-33.586914, -474.813568},{-38.358986, -472.445313},{-43.085239, -470.029419},{-47.765324, -467.566559},{-52.871288, -463.997467},{-57.438713, -461.438843},{-61.958740, -458.835632},{-66.430824, -456.188507},{-71.008369, -454.486328},{-75.393890, -451.751862},{-79.730431, -448.975555},{-84.017281, -446.158173},{-88.448868, -444.281219},{-92.645988, -441.381592},{-97.007210, -439.419617},{-101.112846, -436.440369},{-105.402092, -434.395447},{-109.414856, -431.339081},{-113.630577, -429.213348},{-117.813988, -427.046692},{-121.964676, -424.839508},{-125.797287, -421.633759},{-129.871475, -419.349976},{-133.911713, -417.027161},{-137.918076, -414.665649},{-141.889572, -412.266113},{-146.160797, -410.771240},{-150.072052, -408.293243},{-153.947571, -405.778442},{-157.787170, -403.227234},{-161.963638, -401.567902},{-165.739746, -398.941528},{-169.871307, -397.199860},{-173.582642, -394.499756},{-177.667679, -392.676971},{-181.312744, -389.904724},{-185.349670, -388.001953},{-188.926956, -385.159180},{-192.914322, -383.177612},{-196.880783, -381.154755},{-200.826050, -379.090881},{-204.749695, -376.986176},{-208.651276, -374.840820},{-200.789825, -343.638519},{-223.526749, -364.992859},{-227.834351, -363.500366},{-231.595932, -361.115387},{-235.332626, -358.691437},{-239.043945, -356.228851},{-243.294464, -354.552948},{-246.962433, -352.007904},{-250.603729, -349.424896},{-254.217941, -346.804321},{-258.403564, -344.947235},{-261.970978, -342.245850},{-266.125336, -340.295898},{-270.267548, -338.296387},{-273.765259, -335.472168},{-277.872833, -333.380676},{-281.966675, -331.239807},{-286.045837, -329.049805},{-290.109955, -326.810699},{-294.158081, -324.522766},{-298.190125, -322.185730},{-302.205261, -319.799866},{-306.202881, -317.365387},{-310.182434, -314.882294},{-314.143372, -312.350677},{-318.085144, -309.770630},{-322.730072, -307.833221},{-326.638855, -305.149261},{-331.263702, -303.092987},{-335.136810, -300.305389},{-338.987671, -297.469971},{-343.573547, -295.239258},{-348.149414, -292.945374},{-352.714630, -290.587982},{-356.490326, -287.538940},{-361.025085, -285.062958},{-365.546509, -282.523895},{-370.054108, -279.921356},{-374.546875, -277.255554},{-379.370850, -274.046967},{-383.827087, -271.250397},{-388.265900, -268.390747},{-393.514648, -266.028625},{-397.922028, -263.034363},{-402.309570, -259.976929},{-407.521240, -257.391632},{-411.871735, -254.200043},{-417.055878, -251.462524},{-422.227173, -248.644791},{-427.384674, -245.746506},{-431.655426, -242.277924},{-437.653473, -239.709091},{-441.881073, -236.097687},{-446.967163, -232.886978},{-452.925171, -230.049500},{-457.976135, -226.669052},{-463.905884, -223.643341},{-468.916779, -220.093246},{-473.903687, -216.463120},{-479.779236, -213.159317},{-485.636627, -209.757202},{-491.474731, -206.256104},{-497.292084, -202.656281},{-504.016998, -199.326035},{-509.792389, -195.519073},{-515.542603, -191.613815},{-522.206909, -187.949326},{-525.073669, -182.848755},{-534.523315, -179.946808},{-541.116028, -175.938843},{-547.682739, -171.812805},{-555.178528, -167.859467},{-561.690613, -163.488953},{-569.134216, -159.271027},{-575.584473, -154.656052},{-582.968018, -150.174255},{-590.319946, -145.555496},{-598.611206, -141.030670},{-605.895935, -136.128983},{-614.259888, -130.647766},{-622.444153, -125.651558},{-629.608032, -120.310814},{-638.695496, -115.191277},{-646.757996, -109.727455},{-655.762573, -104.266220},{-664.722595, -98.629768},{-673.635498, -92.818146},{-682.498413, -86.832687},{-692.302063, -80.788765},{-703.047180, -74.656868},{-712.743103, -68.214958},{-723.376465, -61.664364},{-733.949585, -54.900337},{-745.456970, -47.988739},{-755.900330, -40.788849},{-768.271484, -33.465446},{-779.571350, -25.856125},{-791.794556, -18.038256},{-804.938110, -9.982623},{-817.998352, -1.656153},{-831.971008, 6.949026},{-844.851746, 15.825268},{-859.635742, 25.027346},{-874.318115, 34.538307},{-888.893921, 44.356602},{-907.351440, 54.720543},{-915.712097, 64.770988},{-941.902527, 76.449974},{-956.991760, 87.679535},{-975.927063, 99.636139},{-995.708923, 112.105850},{-1015.334717, 124.997971},{-1036.780273, 138.573151},{-1061.020508, 153.034271},{-1084.081055, 167.860397},{-1106.945435, 183.182205},{-1131.575806, 199.342056},{-1157.952881, 216.400192},{-1184.094849, 234.026627},{-1216.651978, 254.572067},{-1250.084106, 275.117920},{-1284.191284, 296.608765},{-1320.899536, 319.539246},{-1601.880127, 512.936646},{-1637.246460, 561.947449},{-1628.503174, 577.893860},{-1617.728027, 593.030334},{-1610.555176, 609.422791},{-1601.353760, 625.001587},{-1592.002197, 640.456787},{-1580.655396, 655.018860},{-1571.017700, 670.199524},{-1560.319824, 684.848877},{-1551.310791, 700.170654},{-1542.151489, 715.380005},{-1532.843872, 730.474854},{-1524.287598, 745.893188},{-1514.682617, 760.763855},{-1508.489746, 777.346436},{-947.579712, 606.397278},{-942.913940, 617.286194},{-933.136719, 624.807800},{-1376.741089, 983.589294},{-1365.573486, 997.341492},{-1357.474731, 1013.359802},{-1347.598633, 1028.106567},{-1338.351929, 1043.370972},{-1328.151611, 1057.930664},{-1319.343750, 1073.654053},{-1308.814575, 1088.029541},{-1299.652466, 1103.597900},{-1289.553223, 1118.437134},{-1280.034180, 1133.848633},{-1271.816650, 1150.524780},{-1261.919800, 1165.796875},{-1251.843140, 1180.986816},{-1241.586914, 1196.092896},{-1231.151367, 1211.113159},{-1222.653931, 1228.171997},{-1212.537720, 1243.752930},{-1202.228516, 1259.256836},{-1192.410767, 1275.410767},{-1181.711060, 1290.759033},{-1172.155518, 1307.511963},{-1161.718140, 1323.454590},{-1151.728149, 1340.078857},{-1140.872559, 1355.873779},{-1131.720459, 1373.902832},{-1120.431519, 1389.553223},{-1109.557739, 1405.902710},{-1098.464844, 1422.175781},{-1088.359131, 1439.965088},{-1077.406250, 1456.893799},{-1065.631226, 1472.940674},{-1055.948608, 1492.165039},{-1044.842407, 1509.702148},{-1032.923096, 1526.341553},{-1022.425903, 1545.397827},{-1011.099365, 1563.560791},{-998.969299, 1580.810059},{-987.640015, 1599.677246},{-974.474976, 1615.910767},{-962.089661, 1634.928955},{-949.294983, 1655.083984},{-935.193604, 1673.410278},{-920.802002, 1691.626343},{-907.993286, 1713.262695},{-893.440063, 1732.156494},{-878.577942, 1750.937378},{-866.040527, 1774.992676},{-850.074463, 1792.659912},{-836.751282, 1816.548218},{-821.367737, 1836.708862},{-806.035461, 1857.668335},{-791.889648, 1882.199463},{-775.032410, 1901.087524},{-759.320007, 1923.553223},{-743.916260, 1947.771484},{-727.720093, 1970.945068},{-711.099365, 1993.997681},{-693.730347, 2015.976685},{-677.847473, 2043.509766},{-659.611023, 2065.220947},{-642.736267, 2092.513184},{-623.919800, 2114.887451},{-605.502014, 2139.986816},{-587.386475, 2167.831543},{-567.971863, 2192.631592},{-548.557068, 2219.207275},{-528.850281, 2246.593262},{-509.037598, 2275.764648},{-488.017853, 2301.835693},{-467.264923, 2331.640625},{0.000420, 2402.000000} };
			this->gui.addPoints(testPoints, "laserreadingType");
			while (this->testMode) {
				auto t1 = std::chrono::high_resolution_clock::now();

				this->ransac.RANdomSAmpleConsensus(testPoints);

				// SLAM

				this->landmarks = this->ransac.getLandMarks();

				auto t2 = std::chrono::high_resolution_clock::now();
				std::chrono::duration<double> duration = t2 - t1;
				gui.changePoints(testPoints, "laserreadingType");
				gui.changeLines(this->landmarks, this->origin, "landmarkLineType");
				gui.changePoints(this->landmarks, "landmarkType");
				gui.changeText(std::to_string(this->timer->elapsed()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(this->landmarks.size()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(duration.count()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string((unsigned int)this->ringRadius), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(testPoints.size()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText("-", "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(this->gui.zoomDevisor), "informationValues");
			}
		}

		void startLiveConnection() {
			std::string lidar_port = "\\\\.\\COM3";
			this->COM_LIDAR = new DA::SerialPort(lidar_port.c_str());
			this->lidar = new DA::LIDAR(*this->COM_LIDAR);
			while (this->gui.isWindowRunning() && !this->lidar->isConnected()) {
				std::cout << "trying to connect to LIDAR on port: " << lidar_port << std::endl;
				std::this_thread::sleep_for(std::chrono::milliseconds(200));
			}

			while (this->lidar->isConnected()) {

				auto t1 = std::chrono::high_resolution_clock::now();

				this->lidar->updateScanPoints();

				this->pointCloud = lidar->getPoints();
				this->ransac.RANdomSAmpleConsensus(this->pointCloud);

				// SLAM

				this->landmarks = this->ransac.getLandMarks();

				auto t2 = std::chrono::high_resolution_clock::now();
				std::chrono::duration<double> duration = t2 - t1;


				gui.changePoints(this->pointCloud, "laserreadingType");
				gui.changeLines(this->landmarks, this->origin, "landmarkLineType");
				gui.changePoints(this->landmarks, "landmarkType");
				gui.changeText(std::to_string(this->timer->elapsed()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(this->landmarks.size()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(duration.count()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string((unsigned int)this->ringRadius), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(this->pointCloud.size()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(this->lidar->getErrorCount()), "informationValues");
				gui.addText("\n", "informationValues");
				gui.addText(std::to_string(this->gui.zoomDevisor), "informationValues");

				lidar->resetPoints();
			}
			this->gui.closeWindow();
		}

	private:
		bool testMode = false;
		bool running = false;
		Timer *timer;
		DA::SerialPort *COM_LIDAR;
		//DA::SerialPort *COM_CONTROLLER;
		DA::LIDAR *lidar;
		DA::RANSAC ransac;
		//DA::SLAM slam(ransac);
		DA::GUI gui;
		LOG::Logger processLogger;
		LOG::Logger commandLogger;

		std::vector<DA::Point> pointCloud;
		std::vector<DA::Point> landmarks;
		DA::Point origin = { 0.f, 0.f };
		sf::Vector2u windowSize = { 1020u, 640u };

		float ringRadius = 2000.f;

		std::thread command_th;

		void _commandEvaluation() {
			std::string command;
			while (true) {
				std::cout << "§";
				std::cin >> command;

				if (command.c_str() == "help") {
					std::cout << "list of commands" << std::endl;
					std::cout	<<	"<start testing>\tinitializes program demo\n"
								<<	"<connect sensor>\testablishes connection with LIDAR"
				}
				else if (command.c_str() == "info") {

				}
				else if (command.c_str() == "start testing") {

				}
				else if (command.c_str() == "connect sensor") {

				}
			}
		}
	};
}